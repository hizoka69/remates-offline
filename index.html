<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Gestor de Remates</title>
    <link rel="icon" type="image/png" href="hzz.png">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- VARIABLES DE MARCA DOSH --- */
        :root {
            --dosh-blue: #003B73;       
            --dosh-green: #9CBF28;      
            --dosh-green-dark: #7da118; 
            --dosh-bg: #d3d4d6;         
            --text-main: #333333;
            --text-light: #777777;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--dosh-bg); padding: 15px; color: var(--text-main); margin: 0; -webkit-tap-highlight-color: transparent; padding-bottom: 50px; }
        .container { max-width: 800px; margin: 0 auto; background: rgb(240, 239, 239); padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 59, 115, 0.08); border-top: 5px solid var(--dosh-green); }
        h1 { color: var(--dosh-blue); font-size: 1.6rem; margin-top: 0; text-align: center; font-weight: 800; letter-spacing: -0.5px; text-transform: uppercase; }
        .subtitle { text-align: center; color: var(--text-light); font-size: 0.9rem; margin-bottom: 25px; font-weight: 500; }
        .slide { display: none; animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .slide.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.1rem; color: var(--dosh-blue); border-bottom: 2px solid var(--dosh-green); padding-bottom: 8px; margin-top: 5px; margin-bottom: 20px; display: inline-block; width: 100%; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        /* RESPONSIVIDAD MEJORADA */
        @media (max-width: 600px) { 
            .row { flex-direction: column; gap: 15px; } 
            .container { padding: 20px; min-height: 90vh; } 
            h2 { font-size: 1.2rem; } 
            .slide { padding-bottom: 20px; } 
            
            /* Correcci√≥n visual para celulares en selecci√≥n de comisi√≥n */
            .radio-group { flex-direction: column !important; align-items: flex-start !important; }
            .radio-group label { 
                margin-bottom: 10px; 
                width: 100%; 
                background: #f8f9fa; 
                padding: 10px; 
                border-radius: 8px; 
                border: 1px solid #e1e5eb;
            }
        }

        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--dosh-blue); }
        .small-note { font-size: 0.75rem; color: #999; display: block; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #e1e5eb; border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: #fafafa; color: #333; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--dosh-blue); outline: none; background-color: #fff; box-shadow: 0 0 0 4px rgba(0, 59, 115, 0.1); }
        .input-editable { background-color: #fff; border: 1px solid #ccc; padding: 8px; font-size: 0.95rem; text-align: right; width: 140px; }
        .input-editable:focus { border-color: var(--dosh-green); background-color: #fefffa; }
        input:disabled { background-color: #f0f2f5; color: #888; border-color: #eee; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; margin-bottom: 15px; }
        .btn-file { border: 2px dashed var(--dosh-blue); color: var(--dosh-blue); background-color: #f8f9fa; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; text-align: center; display: block; box-sizing: border-box; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #preview-container { text-align: center; margin-bottom: 15px; display: none; }
        #preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-buttons { display: flex; gap: 12px; margin-top: 30px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.1s, opacity 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        button:active { transform: scale(0.97); }
        .btn-next { background-color: var(--dosh-blue); color: white; flex: 1; }
        .btn-back { background-color: #e2e6ea; color: var(--text-main); flex: 0.4; }
        .btn-pdf { background-color: var(--dosh-green); color: white; width: 100%; margin-top: 15px; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-new { background-color: #5d7a96; color: white; width: 100%; margin-top: 15px; }
        .result-box { background: #fff; border: 1px solid #e1e5eb; border-radius: 12px; padding: 15px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f2f5; align-items: center; }
        .result-row span:first-child { color: #555; font-size: 0.9rem; flex:1; }
        .result-row span:last-child { font-weight: 600; font-family: 'Segoe UI', monospace; font-size: 1rem; color: #333; }
        .green-text { color: var(--dosh-green-dark); font-weight: bold !important; }
        .red-text { color: #d63384; }
        .brand-text { color: var(--dosh-blue); font-weight: bold; }
        .result-row.total-final { background-color: #f4f9e6; border: 1px solid var(--dosh-green); border-radius: 8px; padding: 15px; margin-top: 15px; color: var(--dosh-blue); }
        .result-row.total-final span:last-child { color: var(--dosh-blue); font-size: 1.5rem; font-weight: 800; }
        details { margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        summary { padding: 12px; background-color: #f8f9fa; color: var(--dosh-blue); font-weight: 600; font-size: 0.85rem; text-align: right; list-style: none; outline: none; cursor: pointer; }
        summary:after { content: " ‚ñº Ver Detalle"; font-size: 0.8rem; opacity: 0.8; }
        details[open] summary:after { content: " ‚ñ≤ Ocultar"; }
        .breakdown-list { background: #fff; padding: 15px; }
        .breakdown-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #666; }
        .breakdown-title { background-color: var(--dosh-blue); color: white; padding: 5px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-align: center; margin: 15px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .breakdown-title:first-child { margin-top: 0; }
        #mensaje { text-align: center; margin-top: 15px; font-weight: bold; color: var(--dosh-green-dark); min-height: 24px; }
        .interest-highlight { background-color: #eef2f7; border-left: 4px solid var(--dosh-blue); padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .interest-highlight .result-row { border-bottom: 1px dashed #ccc; padding: 5px 0; }
        .interest-highlight .result-row:last-child { border-bottom: none; }

        /* --- NUEVOS ESTILOS PANTALLA DE SELECCI√ìN --- */
        .mode-selection-container { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; }
        .mode-card { background: white; border: 2px solid #e1e5eb; border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 59, 115, 0.15); border-color: var(--dosh-blue); }
        .mode-card h3 { color: var(--dosh-blue); margin: 15px 0 10px 0; font-size: 1.3rem; }
        .mode-card p { color: #666; font-size: 0.9rem; margin: 0; line-height: 1.4; }
        .icon-mode { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .badge-new { position: absolute; top: 15px; right: 15px; background: var(--dosh-green); color: white; font-size: 0.7rem; font-weight: bold; padding: 4px 8px; border-radius: 10px; text-transform: uppercase; }
        .macal-option-box { background-color: #e3f2fd; border: 1px solid #90caf9; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }

        /* --- LOGO DEV FOOTER --- */
        .watermark-dev {
            text-align: center;
            padding: 20px 0;
            margin-top: 30px;
            opacity: 0.8;
            width: 100%;
        }
        .watermark-dev img {
            max-height: 90px;
            width: auto;
            transition: opacity 0.3s;
        }
        .watermark-dev img:hover {
            opacity: 1;
        }
    </style>
    
    <script>
        function procesarImagen(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    document.getElementById('preview-container').style.display = 'block';
                    document.querySelector('.btn-file').innerText = "‚úÖ Foto cargada";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</head>
<body>

<div class="container">
    <h1>Gestor De Remates</h1>
    <p class="subtitle" id="main_subtitle">Selecciona el tipo de evaluaci√≥n</p>

    <div id="slide_selection" class="slide active">
        <div class="mode-selection-container">
            
            <div class="mode-card" py-click="iniciar_metodo_normal">
                <span class="icon-mode">üè†</span>
                <h3>M√©todo Normal</h3>
                <p>C√°lculo tradicional con honorarios de b√∫squeda y costos operacionales est√°ndar.</p>
            </div>

            <div class="mode-card" py-click="iniciar_metodo_macal">
                <span class="badge-new">Nuevo</span>
                <span class="icon-mode">‚öñÔ∏è</span>
                <h3>M√©todo Macal</h3>
                <p>Calculadora especializada: Comisiones Macal, Tramos de Escrituraci√≥n (UF) y f√≥rmulas de Notar√≠a/CBR.</p>
            </div>

        </div>
    </div>


    <div id="slide1" class="slide">
        <h2>1. Ficha T√©cnica</h2>
        
        <label>Imagen de la Propiedad (Opcional)</label>
        <div class="file-upload-wrapper">
            <div class="btn-file">üì∑ Toca para subir foto</div>
            <input type="file" id="input_imagen" accept="image/*" onchange="procesarImagen(this)">
        </div>
        <div id="preview-container">
            <img id="preview-img" src="" alt="Vista previa">
        </div>

        <div class="row">
            <div class="col">
                <label>Regi√≥n</label>
                <select id="select_region" py-change="actualizar_comunas">
                    <option value="" disabled selected>Selecciona regi√≥n</option>
                </select>
            </div>
            <div class="col">
                <label>Comuna</label>
                <select id="select_comuna"><option>...</option></select>
            </div>
        </div>

        <label>Nombre Oportunidad</label>
        <input type="text" id="input_nombre" placeholder="Ej: Casa Macal Lote 5">

        <div class="row">
            <div class="col">
                <label>Fecha Remate</label>
                <input type="date" id="input_fecha_remate">
            </div>
            <div class="col">
                <label>Fecha Rescate</label>
                <input type="date" id="input_fecha_rescate">
            </div>
        </div>
        
        <label>Fuente de Informaci√≥n</label>
        <input type="text" id="input_fuente" placeholder="Ej: Macal.cl">
        
        <label style="margin-top: 10px;">üîó Link Publicaci√≥n (URL)</label>
        <input type="url" id="input_link" placeholder="https://www.macal.cl/propiedad/..." style="color: var(--dosh-blue);">

        <div class="row" style="margin-top: 15px;">
            <div class="col">
                <label>Direcci√≥n</label>
                <input type="text" id="input_direccion">
            </div>
            <div class="col">
                <label>Superficie (m¬≤)</label>
                <input type="text" inputmode="numeric" pattern="[0-9]*" id="input_superficie" 
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>

        <label>Notas / Estado</label>
        <textarea id="input_detalles" rows="3"></textarea>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_menu_principal">‚Üê Men√∫</button>
            <button class="btn-next" py-click="ir_slide_2">Siguiente ‚ûù</button>
        </div>
    </div>

    <div id="slide2" class="slide">
        <h2>2. Inversi√≥n y Costos</h2>
        
        <div class="row">
            <div class="col">
                <label>Postura M√≠nima ($)</label>
                <input type="number" inputmode="numeric" id="input_postura_min" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="col">
                <label>Oferta M√°xima ($)</label>
                <input type="number" inputmode="numeric" id="input_oferta_max" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Garant√≠a (Vale Vista)</label>
                <input type="number" inputmode="numeric" id="input_garantia" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="col">
                <label>Meses (Inter√©s)</label>
                <input type="number" inputmode="numeric" id="cant_mes" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>

        <div id="container_costos_normales">
            <h2 style="font-size: 1rem; border:none; margin-bottom: 5px; color: var(--text-light);">Costos Fijos (Editables)</h2>
            <div class="result-box">
                <div class="result-row">
                    <span>‚öñÔ∏è Abogado</span>
                    <input type="number" inputmode="numeric" id="costo_abogado" value="1600000" class="input-editable">
                </div>
                <div class="result-row">
                    <span>üìù Notar√≠a</span>
                    <input type="number" inputmode="numeric" id="costo_notaria" value="300000" class="input-editable">
                </div>
                <div class="result-row">
                    <span>üèõÔ∏è CBR</span>
                    <input type="number" inputmode="numeric" id="costo_cbr" value="300000" class="input-editable">
                </div>
                <div class="result-row">
                    <span>üîì Alzamientos</span>
                    <input type="number" inputmode="numeric" id="costo_alzamientos" value="150000" class="input-editable">
                </div>
                <div class="result-row">
                    <span>‚öñÔ∏è Judiciales</span>
                    <input type="number" inputmode="numeric" id="costo_judiciales" value="300000" class="input-editable">
                </div>
                
                <div class="result-row">
                    <span>üîç B√∫squeda (2%)</span>
                    <span id="disp_busqueda" class="brand-text">--</span>
                </div>
            </div>
        </div>

        <div id="container_msg_macal" style="display:none; text-align: center; color: #666; font-size: 0.9rem; margin-top: 15px; background: #e8f4f8; padding: 10px; border-radius: 8px;">
            <p>‚ÑπÔ∏è En <strong>Modo Macal</strong>, los costos de Escrituraci√≥n, Notar√≠a y CBR se calculan autom√°ticamente seg√∫n las f√≥rmulas oficiales en el siguiente paso.</p>
        </div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_1">‚Üê Atr√°s</button>
            <button class="btn-next" py-click="ir_slide_3">Siguiente ‚ûù</button>
        </div>
    </div>

    <div id="slide3" class="slide">
        
        <div id="macal_options" class="macal-option-box" style="display:none;">
            <h3 style="margin-top:0; color:var(--dosh-blue); font-size:1rem;">‚öôÔ∏è Configuraci√≥n Macal</h3>
            
            <label>Tipo de Comisi√≥n</label>
            <div class="radio-group">
                <label style="font-weight:normal; display:flex; align-items:center; gap:5px;">
                    <input type="radio" name="macal_tipo" id="radio_normal" value="normal" checked> 
                    Normal (3% + IVA)
                </label>
                <label style="font-weight:normal; display:flex; align-items:center; gap:5px;">
                    <input type="radio" name="macal_tipo" id="radio_liq" value="liq"> 
                    Liq. Concursal (2% + IVA)
                </label>
            </div>

            <div class="result-row">
                <span>üìù Notar√≠a (Base $70k + 0.1%)</span>
                <span class="small-note" style="text-align: right;">Autom√°tico</span>
            </div>
            <div class="result-row">
                <span>üèõÔ∏è CBR (0.4%, M√≠n $250k)</span>
                <input type="number" inputmode="numeric" id="macal_cbr_editable" value="250000" class="input-editable">
            </div>
            <div class="result-row" style="margin-top:5px;">
                <span>üìÑ Escrituraci√≥n (Acorde a precio de adjudicacion)</span>
                <span id="disp_escritura_uf" class="brand-text" style="font-size:0.9rem;">-- UF + IVA</span>
            </div>
        </div>
        <h2>3. Proyecci√≥n Venta</h2>
        
        <label>Precio Venta Estimado ($)</label>
        <span class="small-note">Valor mercado estimado</span>
        <input type="number" inputmode="numeric" id="input_venta_vivienda" value="0"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        
        <div class="row" style="margin-top: 15px;">
             <div class="col">
                <label>üõ†Ô∏è Mejoras / Reformas</label>
                <input type="number" inputmode="numeric" id="input_mejoras" value="3000000"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>
        
        <div class="result-box">
             <div class="result-row">
                <span>ü§ù Comisi√≥n Venta (2%)</span>
                <span id="disp_comision" class="brand-text">--</span>
            </div>
            <div class="result-row">
                <span>üßæ IVA Venta (19%)</span>
                <span id="disp_iva" class="brand-text">--</span>
            </div>
            <div class="result-row" id="row_legal_venta">
                 <span>üìÑ Legal Venta (Propia)</span>
                 <input type="number" inputmode="numeric" id="costo_legal_venta" value="100000" class="input-editable">
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_2">‚Üê Atr√°s</button>
            <button class="btn-next" py-click="calcular_y_mostrar_final">Ver Resultados ‚ûù</button>
        </div>
    </div>

    <div id="slide_final" class="slide">
        <h2>üìä Resumen Financiero</h2>
        
        <div class="result-box">
            
            <div class="interest-highlight">
                <div class="result-row">
                    <span>üè¶ Inter√©s Mensual (0.7%)</span>
                    <span id="res_interes_mensual" class="brand-text">$ 0</span>
                </div>  
                <div class="result-row">
                    <span>üìÖ Inter√©s Total Acumulado</span>
                    <span id="res_interes_total" class="red-text">$ 0</span>
                </div>
            </div>

            <div class="result-row">
                <span>üìâ <strong>Total Egresos</strong></span>
                <span id="res_subtotal_gastos" class="red-text" style="color: #c0392b;">$ 0</span>
            </div>
            <details>
                <summary>Ver Desglose Gastos</summary>
                <div id="breakdown_gastos" class="breakdown-list"></div>
            </details>

            <div class="result-row">
                <span>üìà <strong>Total Ingresos</strong></span>
                <span id="res_total_ingresos" class="green-text">$ 0</span>
            </div>
            <details>
                <summary>Ver Desglose Ingresos</summary>
                <div id="breakdown_ingresos" class="breakdown-list"></div>
            </details>

            <div class="result-row" style="margin-top: 10px; border-top: 2px solid #eee; padding-top: 10px;">
                <span>üí∞ Utilidad Bruta</span>
                <span id="res_saldo_favor" style="font-weight: bold;">$ 0</span>
            </div>

            <div class="result-row">
                <span>üèõÔ∏è Impuesto (27%)</span>
                <span id="res_impuesto" class="brand-text">$ 0</span>
            </div>

            <div class="result-row total-final">
                <span>üöÄ UTILIDAD NETA</span>
                <span id="res_saldo_final_liquido">$ 0</span>
            </div>
            
            <div class="row" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <div class="col" style="text-align: center;">
                    <span style="font-size: 0.8rem; color: #666;">ROI</span><br>
                    <span id="res_roi" style="font-weight: bold; color: var(--dosh-green-dark);">0%</span>
                </div>
                <div class="col" style="text-align: center;">
                    <span style="font-size: 0.8rem; color: #666;">Rentabilidad</span><br>
                    <span id="res_rentabilidad" style="font-weight: bold; color: var(--dosh-blue);">0%</span>
                </div>
            </div>
        </div>

        <button class="btn-pdf" py-click="generar_pdf_completo">üì• Descargar Ficha PDF Detallada</button>
        <button class="btn-new" py-click="nueva_operacion">üîÑ Nueva Operaci√≥n / Men√∫</button>
        <div id="mensaje"></div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_3">‚Üê Editar</button>
        </div>
    </div>
    
    <div id="sec_ia" style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; display: none;">
        <h2>ü§ñ Asesor√≠a con IA (Groq)</h2>
        <button onclick="consultarGroq()" 
                style="background: linear-gradient(45deg, #4285f4, #9b72cb); color: white; width: 100%;">
             Analizar Oportunidad con IA
        </button>

        <div id="loading_ai" style="display:none; text-align: center; margin-top: 15px;">
            <p>üß† Cargando...</p>
            <p>Porfavor espere</p>
        </div>

        <div id="resultado_ai" style="margin-top: 15px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; display: none; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5;"></div>
    </div>
</div>

<div class="watermark-dev">
    <img src="hzz.png" alt="Desarrollado por Joaqu√≠n Hern√°ndez">
</div>

<script type="py">
    
    from pyscript import document, window
    from js import jspdf
    import datetime

    # --- DATOS REGIONALES ---
    CHILE_DATA = {
        "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
        "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"],
        "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"],
        "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
        "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paihuano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"],
        "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"],
        "Metropolitana": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"],
        "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchig√ºe", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
        "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
        "√ëuble": ["Chill√°n", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chill√°n Viejo", "El Carmen", "Ninhue", "√ëiqu√©n", "Pemuco", "Pinto", "Portezuelo", "Quill√≥n", "Quirihue", "R√°nquil", "San Carlos", "San Fabi√°n", "San Ignacio", "San Nicol√°s", "Treguaco", "Yungay"],
        "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"],
        "Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"],
        "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"],
        "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"],
        "Ays√©n": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"],
        "Magallanes": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
    }
    
    # --- CONSTANTES ---
    VALOR_UF = 38000 # Valor referencia UF para c√°lculos    
    DEF_ABOGADO = 1600000
    DEF_NOTARIA = 300000
    DEF_CBR = 300000
    DEF_ALZAMIENTOS = 150000
    DEF_JUDICIALES = 300000
    DEF_LEGAL_VENTA = 100000
    
    # Variables Globales (simuladas)
    MODO_ACTUAL = "NORMAL"
    MACAL_COSTO_ESCRITURA = 0
    MACAL_COSTO_COMISION = 0
    MACAL_COSTO_NOTARIA = 0
    MACAL_COSTO_CBR = 0
    MACAL_COSTO_BUSQUEDA = 0
    UF_COBRO_LABEL = ""

    def format_money(valor):
        return "${:,.0f}".format(valor).replace(",", ".")

    def iniciar_app():
        select = document.getElementById("select_region")
        for reg in CHILE_DATA.keys():
            opt = document.createElement("option")
            opt.text = reg
            opt.value = reg
            select.add(opt)

    def actualizar_comunas(event):
        reg = event.target.value
        sel_com = document.getElementById("select_comuna")
        sel_com.innerHTML = ""
        for c in CHILE_DATA.get(reg, []):
            opt = document.createElement("option")
            opt.text = c
            opt.value = c
            sel_com.add(opt)

    # --- NAVEGACI√ìN ---
    def cambiar_slide(id_mostrar):
        ids = ["slide_selection", "slide1", "slide2", "slide3", "slide_final"]
        
        subt = document.getElementById("main_subtitle")
        sec_ia = document.getElementById("sec_ia")
        
        if id_mostrar == "slide_selection":
             subt.innerText = "Selecciona el tipo de evaluaci√≥n"
             sec_ia.style.display = "none"
        elif id_mostrar == "slide_final":
             subt.innerText = "Resumen de Resultados"
             sec_ia.style.display = "block"
        else:
             subt.innerText = "Evaluaci√≥n Econ√≥mica de Remates"
             sec_ia.style.display = "none"

        for i in ids:
            el = document.getElementById(i)
            if i == id_mostrar:
                el.classList.add("active")
            else:
                el.classList.remove("active")
        window.scrollTo(0, 0)

    # --- FUNCIONES DE MODO ---
    def ir_menu_principal(e):
        cambiar_slide("slide_selection")
    
    def iniciar_metodo_normal(e):
        global MODO_ACTUAL
        MODO_ACTUAL = "NORMAL"
        
        # Mostrar costos normales en slide 2
        document.getElementById("container_costos_normales").style.display = "block"
        document.getElementById("container_msg_macal").style.display = "none"
        
        # Ocultar opciones Macal en Slide 3
        document.getElementById("macal_options").style.display = "none"
        
        cambiar_slide("slide1")
        
    def iniciar_metodo_macal(e):
        global MODO_ACTUAL
        MODO_ACTUAL = "MACAL"
        
        # Ocultar inputs de costos normales (se calculan auto)
        document.getElementById("container_costos_normales").style.display = "none"
        document.getElementById("container_msg_macal").style.display = "block"
        
        # Mostrar opciones Macal en Slide 3
        document.getElementById("macal_options").style.display = "block"
        
        cambiar_slide("slide1")
        
    def ir_slide_1(e): cambiar_slide("slide1")
    def ir_slide_2(e): cambiar_slide("slide2")
    def ir_slide_3(e): cambiar_slide("slide3")

    def nueva_operacion(e):
        ids_text = ["input_nombre", "input_direccion", "input_superficie", "input_detalles", "input_fuente", "input_link"]
        for i in ids_text: document.getElementById(i).value = ""

        ids_num = ["input_postura_min", "input_oferta_max", "input_garantia", 
                   "input_venta_vivienda", "input_mejoras", "cant_mes"]
        for i in ids_num: document.getElementById(i).value = "0"
        
        # Reset Costos Default
        document.getElementById("costo_abogado").value = str(DEF_ABOGADO)
        document.getElementById("costo_notaria").value = str(DEF_NOTARIA)
        document.getElementById("costo_cbr").value = str(DEF_CBR)
        document.getElementById("costo_alzamientos").value = str(DEF_ALZAMIENTOS)
        document.getElementById("costo_judiciales").value = str(DEF_JUDICIALES)
        document.getElementById("costo_legal_venta").value = str(DEF_LEGAL_VENTA)
        document.getElementById("input_mejoras").value = "3000000"
        
        # Reset Macal
        document.getElementById("radio_normal").checked = True
        document.getElementById("macal_cbr_editable").value = "250000"

        document.getElementById("input_fecha_remate").value = ""
        document.getElementById("input_fecha_rescate").value = ""
        document.getElementById("select_region").selectedIndex = 0
        document.getElementById("select_comuna").innerHTML = "<option>...</option>"

        spans_calc = ["disp_busqueda", "disp_comision", "disp_iva", "res_interes_mensual", "res_interes_total", "res_roi", "res_rentabilidad", "disp_escritura_uf"]
        for s in spans_calc: 
            elem = document.getElementById(s)
            if elem: elem.innerText = "--"

        spans_res = ["res_subtotal_gastos", "res_total_ingresos", "res_saldo_favor", "res_impuesto", "res_saldo_final_liquido"]
        for s in spans_res: document.getElementById(s).innerText = "$ 0"
            
        document.getElementById("mensaje").innerText = ""
        document.getElementById("breakdown_gastos").innerHTML = ""
        document.getElementById("breakdown_ingresos").innerHTML = ""
        document.getElementById("resultado_ai").style.display = "none"
        document.getElementById("input_imagen").value = ""
        document.getElementById("preview-img").src = ""
        document.getElementById("preview-container").style.display = "none"
        document.querySelector(".btn-file").innerText = "üì∑ Toca para subir foto"

        cambiar_slide("slide_selection")

    # --- C√ÅLCULOS ---
    def get_val(id_elem):
        v = document.getElementById(id_elem).value
        if not v: return 0.0
        try: return float(v)
        except: return 0.0

    def crear_fila_desglose(label, valor):
        return f'<div class="breakdown-item"><span>{label}</span><span>{format_money(valor)}</span></div>'
    
    def crear_titulo_desglose(titulo):
        return f'<div class="breakdown-title">{titulo}</div>'

    # --- L√ìGICA MACAL: TRAMOS ESCRITURACI√ìN ---
    def calcular_escritura_macal(precio_adj):
        # Tramos UF
        if precio_adj <= 9999999: uf = 16
        elif precio_adj <= 49999999: uf = 26
        elif precio_adj <= 69999999: uf = 32
        elif precio_adj <= 99999999: uf = 33
        elif precio_adj <= 149999999: uf = 37
        else: uf = 42
        
        return uf, (uf * VALOR_UF) * 1.19 # Valor + IVA

    def calcular_y_mostrar_final(e):
        # Globales para usar en PDF
        global MACAL_COSTO_ESCRITURA, MACAL_COSTO_COMISION, MACAL_COSTO_NOTARIA, MACAL_COSTO_CBR, MACAL_COSTO_BUSQUEDA, UF_COBRO_LABEL
        
        # 1. Inputs
        postura_min = get_val("input_postura_min")
        oferta_max = get_val("input_oferta_max") 
        garantia = get_val("input_garantia")
        venta_vivienda = get_val("input_venta_vivienda")
        costo_mejoras = get_val("input_mejoras")
        meses_interes = get_val("cant_mes")
        
        c_alzamientos = get_val("costo_alzamientos") 
        c_legal_venta = get_val("costo_legal_venta")

        # --- SELECCI√ìN DE L√ìGICA ---
        precio_adjudicacion = oferta_max if oferta_max > 0 else postura_min

        if MODO_ACTUAL == "MACAL":
            # 1. Comisi√≥n Macal
            if document.getElementById("radio_liq").checked:
                tasa_comision = 0.02
                label_comision_compra = "Comisi√≥n Liq. (2% + IVA)"
            else:
                tasa_comision = 0.03
                label_comision_compra = "Comisi√≥n Normal (3% + IVA)"
            
            MACAL_COSTO_COMISION = (precio_adjudicacion * tasa_comision) * 1.19

            # 2. Escrituraci√≥n (Post-Venta)
            uf_cobro, costo_escritura = calcular_escritura_macal(precio_adjudicacion)
            MACAL_COSTO_ESCRITURA = costo_escritura
            UF_COBRO_LABEL = f"{uf_cobro} UF"
            document.getElementById("disp_escritura_uf").innerText = f"{uf_cobro} UF + IVA"

            # 3. Notar√≠a
            MACAL_COSTO_NOTARIA = 70000 + (precio_adjudicacion * 0.001)

            # 4. CBR
            cbr_usuario = get_val("macal_cbr_editable")
            calc_cbr_min = precio_adjudicacion * 0.004
            
            if cbr_usuario == 250000:
                MACAL_COSTO_CBR = 250000 if calc_cbr_min < 250000 else calc_cbr_min
                document.getElementById("macal_cbr_editable").value = str(int(MACAL_COSTO_CBR))
            else:
                MACAL_COSTO_CBR = cbr_usuario

            # 5. B√∫squeda (2% de Suma)
            MACAL_COSTO_BUSQUEDA = (postura_min + oferta_max) * 0.02
            label_busqueda = "B√∫squeda (2% Suma)"
            
            # Variables Normales en 0
            costo_abogado = 0
            costo_judiciales = 0 
            costo_notaria_normal = 0
            costo_cbr_normal = 0
            costo_busqueda_normal = 0

        else:
            # MODO NORMAL
            costo_abogado = get_val("costo_abogado")
            costo_notaria_normal = get_val("costo_notaria")
            costo_cbr_normal = get_val("costo_cbr")
            costo_judiciales = get_val("costo_judiciales")
            
            # B√∫squeda tradicional
            suma_ofertas = postura_min + oferta_max 
            costo_busqueda_normal = suma_ofertas * 0.02
            label_busqueda = "Honorarios B√∫squeda (2%)"
            
            # Variables Macal en 0
            MACAL_COSTO_COMISION = 0
            MACAL_COSTO_ESCRITURA = 0
            MACAL_COSTO_NOTARIA = 0
            MACAL_COSTO_CBR = 0
            MACAL_COSTO_BUSQUEDA = 0

        # --- C√ÅLCULOS FINALES COMUNES ---
        comision_venta = venta_vivienda * 0.02
        iva_venta = (venta_vivienda / 1.19) * 0.19
        
        # Total Gastos Fijos Compra
        if MODO_ACTUAL == "MACAL":
            gastos_operacionales = (MACAL_COSTO_NOTARIA + 
                                    MACAL_COSTO_CBR + 
                                    c_alzamientos + 
                                    MACAL_COSTO_ESCRITURA + 
                                    MACAL_COSTO_COMISION +
                                    MACAL_COSTO_BUSQUEDA)
        else:
            gastos_operacionales = (costo_abogado + 
                                    costo_notaria_normal + 
                                    costo_cbr_normal + 
                                    c_alzamientos + 
                                    costo_judiciales + 
                                    costo_busqueda_normal)
        
        base_calculo_interes = (gastos_operacionales + 
                                garantia + 
                                postura_min + 
                                oferta_max + 
                                costo_mejoras + 
                                comision_venta + 
                                c_legal_venta + 
                                iva_venta)

        interes_mensual = base_calculo_interes * 0.007
        interes_total = interes_mensual * meses_interes

        subtotal_gasto = base_calculo_interes + interes_total
        total_ingresos = venta_vivienda + garantia
        
        saldo_favor = total_ingresos - subtotal_gasto
        impuesto = saldo_favor * 0.27 if saldo_favor > 0 else 0
        saldo_final = saldo_favor - impuesto

        roi = (saldo_final / subtotal_gasto) * 100 if subtotal_gasto > 0 else 0
        rentabilidad = (saldo_final / venta_vivienda) * 100 if venta_vivienda > 0 else 0

        # UI Updates
        if MODO_ACTUAL == "MACAL":
             document.getElementById("disp_busqueda").innerText = format_money(MACAL_COSTO_BUSQUEDA)
        else:
             document.getElementById("disp_busqueda").innerText = format_money(costo_busqueda_normal)

        document.getElementById("disp_comision").innerText = format_money(comision_venta)
        document.getElementById("disp_iva").innerText = format_money(iva_venta)
        
        document.getElementById("res_interes_mensual").innerText = format_money(interes_mensual)
        document.getElementById("res_interes_total").innerText = format_money(interes_total)

        document.getElementById("res_subtotal_gastos").innerText = format_money(subtotal_gasto)
        document.getElementById("res_total_ingresos").innerText = format_money(total_ingresos)
        document.getElementById("res_saldo_favor").innerText = format_money(saldo_favor)
        document.getElementById("res_impuesto").innerText = format_money(impuesto)
        document.getElementById("res_saldo_final_liquido").innerText = format_money(saldo_final)
        
        document.getElementById("res_roi").innerText = "{:.1f}%".format(roi)
        document.getElementById("res_rentabilidad").innerText = "{:.1f}%".format(rentabilidad)

        # DESGLOSE HTML
        html_gastos = ""
        html_gastos += crear_titulo_desglose("1. Inversi√≥n Inicial")
        html_gastos += crear_fila_desglose("Postura M√≠nima", postura_min)
        html_gastos += crear_fila_desglose("Oferta M√°xima", oferta_max)
        html_gastos += crear_fila_desglose("Garant√≠a", garantia)
        
        html_gastos += crear_titulo_desglose("2. Gastos Operacionales")
        
        if MODO_ACTUAL == "MACAL":
            html_gastos += crear_fila_desglose(label_busqueda, MACAL_COSTO_BUSQUEDA)
            html_gastos += crear_fila_desglose(label_comision_compra, MACAL_COSTO_COMISION)
            html_gastos += crear_fila_desglose(f"Serv. Postventa ({UF_COBRO_LABEL})", MACAL_COSTO_ESCRITURA)
            html_gastos += crear_fila_desglose("Notar√≠a (Macal)", MACAL_COSTO_NOTARIA)
            html_gastos += crear_fila_desglose("CBR (Macal)", MACAL_COSTO_CBR)
        else:
            html_gastos += crear_fila_desglose(label_busqueda, costo_busqueda_normal)
            html_gastos += crear_fila_desglose("Abogado", costo_abogado)
            html_gastos += crear_fila_desglose("Notar√≠a", costo_notaria_normal)
            html_gastos += crear_fila_desglose("CBR", costo_cbr_normal)
            html_gastos += crear_fila_desglose("Judiciales", costo_judiciales)

        html_gastos += crear_fila_desglose("Alzamientos", c_alzamientos)
        
        html_gastos += crear_titulo_desglose("3. Habilitaci√≥n y Venta")
        html_gastos += crear_fila_desglose("Mejoras", costo_mejoras)
        html_gastos += crear_fila_desglose("IVA D√©bito", iva_venta)
        html_gastos += crear_fila_desglose("Comisi√≥n Venta", comision_venta)
        html_gastos += crear_fila_desglose("Legal Venta", c_legal_venta)
        
        html_gastos += crear_titulo_desglose("4. Costo Financiero")
        html_gastos += crear_fila_desglose(f"Inter√©s ({meses_interes} meses)", interes_total)
        
        document.getElementById("breakdown_gastos").innerHTML = html_gastos

        html_ingresos = ""
        html_ingresos += crear_titulo_desglose("Entradas de Dinero")
        html_ingresos += crear_fila_desglose("Venta Vivienda", venta_vivienda)
        html_ingresos += crear_fila_desglose("Reembolso Garant√≠a", garantia)
        document.getElementById("breakdown_ingresos").innerHTML = html_ingresos

        cambiar_slide("slide_final")

    # --- PDF ---
    def generar_pdf_completo(e):
        # Recalcular para asegurar datos
        calcular_y_mostrar_final(None)
        
        nombre = document.getElementById("input_nombre").value
        str_remate = document.getElementById("input_fecha_remate").value
        str_link = document.getElementById("input_link").value or "No especificado"
        
        # Recuperar totales visuales
        ingresos = document.getElementById("res_total_ingresos").innerText
        egresos = document.getElementById("res_subtotal_gastos").innerText
        utilidad = document.getElementById("res_saldo_final_liquido").innerText
        
        doc = window.jspdf.jsPDF.new()
        
        # --- IMAGEN PDF (CORREGIDO) ---
        img_element = document.getElementById("preview-img")
        if img_element.src and "data:image" in img_element.src:
            try:
                orig_w = img_element.naturalWidth
                orig_h = img_element.naturalHeight
                max_w = 50; max_h = 50
                ratio = orig_w / orig_h
                if ratio > 1: final_w = max_w; final_h = max_w / ratio
                else: final_h = max_h; final_w = max_h * ratio
                
                # Detectar tipo de imagen (PNG o JPEG)
                img_format = "PNG" if "png" in img_element.src else "JPEG"
                doc.addImage(img_element.src, img_format, 140, 10, final_w, final_h)
            except: pass 
        
        doc.setFont("helvetica", "bold"); doc.setFontSize(22)
        
        if MODO_ACTUAL == "MACAL":
            doc.setTextColor(0, 59, 115) # Azul Dosh
            doc.text("FICHA EVALUACI√ìN MACAL", 20, 25)
        else:
            doc.text("FICHA EVALUACI√ìN REMATE", 20, 25)
            
        doc.setTextColor(0, 0, 0); doc.setFontSize(12)
        doc.text(f"Oportunidad: {nombre}", 20, 40)
        doc.text(f"Fecha Remate: {str_remate}", 20, 48)

        doc.setFontSize(9) # Letra m√°s peque√±a para que quepa la URL
        doc.setTextColor(0, 59, 115) # Azul Dosh
        doc.text(f"Link: {str_link}", 20, 54)
        
        doc.setDrawColor(156, 191, 40) # Verde Dosh
        doc.line(20, 60, 190, 60)
        
        doc.setFontSize(14); doc.text("Resumen Financiero", 20, 70)
        doc.setFontSize(11)
        doc.text(f"Total Ingresos: {ingresos}", 20, 80)
        doc.text(f"Total Egresos: {egresos}", 20, 88)
        
        # Desglose breve en PDF seg√∫n modo
        doc.setFontSize(10); doc.setTextColor(100, 100, 100)
        y_det = 95
        if MODO_ACTUAL == "MACAL":
             doc.text(f"- Comisi√≥n Macal: {format_money(MACAL_COSTO_COMISION)}", 20, y_det); y_det+=5
             doc.text(f"- Servicio Postventa: {format_money(MACAL_COSTO_ESCRITURA)}", 20, y_det); y_det+=5
             doc.text(f"- Notar√≠a + CBR: {format_money(MACAL_COSTO_NOTARIA + MACAL_COSTO_CBR)}", 20, y_det); y_det+=10
        
        doc.setFontSize(16); doc.setTextColor(0, 100, 0)
        doc.text(f"UTILIDAD NETA: {utilidad}", 20, y_det+10)

        pdf_base64 = doc.output('datauristring')
        window.enviarPDFAlBackend(pdf_base64, nombre)
        
        doc.save(f"Ficha_{nombre}.pdf")
        document.getElementById("mensaje").innerText = "‚úÖ PDF Generado"

    iniciar_app()
</script>

<script>
    async function consultarGroq() {
        const nombre = document.getElementById('input_nombre').value || "Propiedad Ejemplo";
        const totalGastos = document.getElementById('res_subtotal_gastos').innerText;
        const totalIngresos = document.getElementById('res_total_ingresos').innerText;
        const utilidad = document.getElementById('res_saldo_final_liquido').innerText;
        const roi = document.getElementById('res_roi').innerText;
        const rentabilidad = document.getElementById('res_rentabilidad').innerText;
        const notas = document.getElementById('input_detalles').value;
        const mejoras = document.getElementById('input_mejoras').value;
        const link = document.getElementById('input_link').value || "No especificado";
        
        // --- DETECCI√ìN CORREGIDA DE MODO MACAL ---
        // Verificamos si el div de opciones Macal est√° visible en la pantalla
        const macalDiv = document.getElementById('macal_options');
        const esMacal = macalDiv && macalDiv.style.display !== 'none';
        
        const contextoExtra = esMacal ? "Considera que es un Remate Macal: Comisi√≥n 3%+IVA y gastos operacionales fijos en UF." : "Es un remate judicial tradicional.";

        const prompt = `
            Act√∫a como un Senior Real Estate Investment Analyst (Analista de Inversiones Inmobiliarias Senior). 
            Tu trabajo es proteger mi capital. S√© cr√≠tico, esc√©ptico y directo.
            
            CONTEXTO DEL NEGOCIO:
            ${contextoExtra}
            Link Referencia: ${link} (√ösalo para inferir contexto si es posible, o menci√≥nalo como fuente)
            
            DATOS FINANCIEROS:
            - Oportunidad: ${nombre}
            - Inversi√≥n Total (All-in): ${totalGastos}
            - Venta Proyectada: ${totalIngresos}
            - Presupuesto Mejoras: $${mejoras}
            - Utilidad Neta: ${utilidad}
            - ROI: ${roi}
            - Rentabilidad s/Venta: ${rentabilidad}
            
            NOTAS DEL TERRENO/ESTADO (CR√çTICO):
            "${notas}"

            TU TAREA (Responde en este formato exacto):

            1. üõ°Ô∏è AN√ÅLISIS DE RIESGO (0-10):
               - Califica el riesgo del 1 al 10.
               - Si las notas dicen "Ocupada", asume riesgo alto por desalojo (costo y tiempo).
               - Si el ROI es menor al 15%, advierte que el margen es muy estrecho para imprevistos.

            2. üìâ STRESS TEST (Escenario Pesimista):
               - ¬øSigo ganando dinero si la propiedad se vende un 10% m√°s barata de lo estimado? Responde SI/NO y por qu√©.
               - ¬øEs el presupuesto de mejoras realista para el estado descrito?

            3. üí° VEREDICTO PROFESIONAL:
               - ¬øAPRUEBAS o RECHAZAS la operaci√≥n?
               - Dame 1 raz√≥n t√©cnica (ej: liquidez, carga financiera, margen de seguridad).

            4. üöÄ ACCIONES INMEDIATAS:
               - Menciona 2 cosas que debo ir a investigar YA (ej: deudas de gastos comunes, estado del techo, precio m2 vecinal).


            HAZ UNA CONCLUSION COMPLETA Y CERTERA PERO A LA VEZ BREVE.
            - Desp√≠dete siempre diciendo: "Programa desarrollado po Hizoka."
        `;

        document.getElementById('loading_ai').style.display = 'block';
        document.getElementById('resultado_ai').style.display = 'none';

        try {
            const response = await fetch('/api/analizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);

            const data = await response.json();
            
            if (data.result) {
                mostrarResultado(data.result);
            } else {
                throw new Error("La IA no devolvi√≥ resultados.");
            }

        } catch (error) {
            console.warn("‚ö†Ô∏è Modo simulaci√≥n activado.", error);
            const respuestaSimulada = `
            <strong>‚ö†Ô∏è MODO DEMOSTRACI√ìN</strong><br><br>
            <strong>1. üõ°Ô∏è AN√ÅLISIS DE RIESGO: 7/10</strong><br>
            El riesgo es medio-alto. Al ser una propiedad "Ocupada", debes considerar 6-8 meses de juicio de precario. Tu ROI de ${roi} es atractivo, pero se diluir√° en el tiempo.<br><br>
            <strong>2. üìâ STRESS TEST:</strong><br>
            Si vendes un 10% m√°s barato, tu utilidad cae dr√°sticamente. El margen de seguridad es bajo.<br><br>
            <strong>3. üí° VEREDICTO: REVISAR CON CAUTELA</strong><br>
            Solo ofertar si tienes espalda financiera para aguantar 12 meses sin liquidez.<br><br>
            <br><em>Programa desarrollado por Hizoka.</em>
            `;
            setTimeout(() => {
                mostrarResultado(respuestaSimulada);
            }, 1000);
        }
    }

    function mostrarResultado(textoHTML) {
        const resultDiv = document.getElementById('resultado_ai');
        // Convertimos markdown a HTML simple
        let formatted = textoHTML
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/üõ°Ô∏è/g, '<span style="font-size:1.2em">üõ°Ô∏è</span>')
            .replace(/üìâ/g, '<span style="font-size:1.2em">üìâ</span>')
            .replace(/üí°/g, '<span style="font-size:1.2em">üí°</span>');
            
        resultDiv.innerHTML = formatted;
        resultDiv.style.display = 'block';
        resultDiv.style.borderLeft = "5px solid #9CBF28"; 
        document.getElementById('loading_ai').style.display = 'none';
    }
</script>

<script>
    // ... tu c√≥digo existente ...

    async function enviarPDFAlBackend(pdfDataUri, nombreArchivo) {
        const mensajeDiv = document.getElementById("mensaje");
        mensajeDiv.innerText = "‚è≥ Generando PDF y enviando correo...";
        
        try {
            // El correo "preseleccionado" puede ir hardcodeado aqu√≠ o en el backend
            // Aqu√≠ lo dejamos flexible por si quieres cambiarlo en el futuro
            const response = await fetch('/api/enviar-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pdfBase64: pdfDataUri,
                    nombreArchivo: nombreArchivo,
                    destinatario: "tucorreo@ejemplo.com" // <--- CAMBIA ESTO POR EL CORREO FIJO
                })
            });

            if (response.ok) {
                mensajeDiv.innerText = "‚úÖ PDF Descargado y enviado por correo.";
            } else {
                mensajeDiv.innerText = "‚ö†Ô∏è PDF Descargado, pero fall√≥ el env√≠o de correo.";
                console.error("Error env√≠o:", await response.text());
            }
        } catch (e) {
            console.error(e);
            mensajeDiv.innerText = "‚ö†Ô∏è Error de conexi√≥n al enviar correo.";
        }
    }
</script>




</body>
</html>
