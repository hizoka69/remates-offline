<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Gestor de Remates</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- VARIABLES DE MARCA DOSH --- */
        :root {
            --dosh-blue: #003B73;       
            --dosh-green: #9CBF28;      
            --dosh-green-dark: #7da118; 
            --dosh-bg: #848586;         
            --text-main: #333333;
            --text-light: #777777;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--dosh-bg); padding: 15px; color: var(--text-main); margin: 0; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 800px; margin: 0 auto; background: rgb(240, 239, 239); padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 59, 115, 0.08); border-top: 5px solid var(--dosh-green); }
        h1 { color: var(--dosh-blue); font-size: 1.6rem; margin-top: 0; text-align: center; font-weight: 800; letter-spacing: -0.5px; text-transform: uppercase; }
        .subtitle { text-align: center; color: var(--text-light); font-size: 0.9rem; margin-bottom: 25px; font-weight: 500; }
        .slide { display: none; animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .slide.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.1rem; color: var(--dosh-blue); border-bottom: 2px solid var(--dosh-green); padding-bottom: 8px; margin-top: 5px; margin-bottom: 20px; display: inline-block; width: 100%; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        @media (max-width: 600px) { .row { flex-direction: column; gap: 15px; } .container { padding: 20px; min-height: 90vh; } h2 { font-size: 1.2rem; } .slide { padding-bottom: 20px; } }
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--dosh-blue); }
        .small-note { font-size: 0.75rem; color: #999; display: block; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #e1e5eb; border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: #fafafa; color: #333; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--dosh-blue); outline: none; background-color: #fff; box-shadow: 0 0 0 4px rgba(0, 59, 115, 0.1); }
        .input-editable { background-color: #fff; border: 1px solid #ccc; padding: 8px; font-size: 0.95rem; text-align: right; width: 140px; }
        .input-editable:focus { border-color: var(--dosh-green); background-color: #fefffa; }
        input:disabled { background-color: #f0f2f5; color: #888; border-color: #eee; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; margin-bottom: 15px; }
        .btn-file { border: 2px dashed var(--dosh-blue); color: var(--dosh-blue); background-color: #f8f9fa; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; text-align: center; display: block; box-sizing: border-box; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #preview-container { text-align: center; margin-bottom: 15px; display: none; }
        #preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-buttons { display: flex; gap: 12px; margin-top: 30px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.1s, opacity 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        button:active { transform: scale(0.97); }
        .btn-next { background-color: var(--dosh-blue); color: white; flex: 1; }
        .btn-back { background-color: #e2e6ea; color: var(--text-main); flex: 0.4; }
        .btn-pdf { background-color: var(--dosh-green); color: white; width: 100%; margin-top: 15px; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-new { background-color: #5d7a96; color: white; width: 100%; margin-top: 15px; }
        .result-box { background: #fff; border: 1px solid #e1e5eb; border-radius: 12px; padding: 15px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f2f5; align-items: center; }
        .result-row span:first-child { color: #555; font-size: 0.9rem; flex:1; }
        .result-row span:last-child { font-weight: 600; font-family: 'Segoe UI', monospace; font-size: 1rem; color: #333; }
        .green-text { color: var(--dosh-green-dark); font-weight: bold !important; }
        .red-text { color: #d63384; }
        .brand-text { color: var(--dosh-blue); font-weight: bold; }
        .result-row.total-final { background-color: #f4f9e6; border: 1px solid var(--dosh-green); border-radius: 8px; padding: 15px; margin-top: 15px; color: var(--dosh-blue); }
        .result-row.total-final span:last-child { color: var(--dosh-blue); font-size: 1.5rem; font-weight: 800; }
        details { margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        summary { padding: 12px; background-color: #f8f9fa; color: var(--dosh-blue); font-weight: 600; font-size: 0.85rem; text-align: right; list-style: none; outline: none; cursor: pointer; }
        summary:after { content: " ‚ñº Ver Detalle"; font-size: 0.8rem; opacity: 0.8; }
        details[open] summary:after { content: " ‚ñ≤ Ocultar"; }
        .breakdown-list { background: #fff; padding: 15px; }
        .breakdown-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #666; }
        .breakdown-title { background-color: var(--dosh-blue); color: white; padding: 5px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-align: center; margin: 15px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .breakdown-title:first-child { margin-top: 0; }
        #mensaje { text-align: center; margin-top: 15px; font-weight: bold; color: var(--dosh-green-dark); min-height: 24px; }
        .interest-highlight { background-color: #eef2f7; border-left: 4px solid var(--dosh-blue); padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .interest-highlight .result-row { border-bottom: 1px dashed #ccc; padding: 5px 0; }
        .interest-highlight .result-row:last-child { border-bottom: none; }

        /* --- NUEVOS ESTILOS PANTALLA DE SELECCI√ìN --- */
        .mode-selection-container { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; }
        .mode-card { background: white; border: 2px solid #e1e5eb; border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 59, 115, 0.15); border-color: var(--dosh-blue); }
        .mode-card h3 { color: var(--dosh-blue); margin: 15px 0 10px 0; font-size: 1.3rem; }
        .mode-card p { color: #666; font-size: 0.9rem; margin: 0; line-height: 1.4; }
        .icon-mode { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .badge-new { position: absolute; top: 15px; right: 15px; background: var(--dosh-green); color: white; font-size: 0.7rem; font-weight: bold; padding: 4px 8px; border-radius: 10px; text-transform: uppercase; }

    </style>
    
    <script>
        function procesarImagen(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    document.getElementById('preview-container').style.display = 'block';
                    document.querySelector('.btn-file').innerText = "‚úÖ Foto cargada";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</head>
<body>

<div class="container">
    <h1>Gestor De Remates</h1>
    <p class="subtitle" id="main_subtitle">Selecciona el tipo de evaluaci√≥n</p>

    <div id="slide_selection" class="slide active">
        <div class="mode-selection-container">
            
            <div class="mode-card" py-click="iniciar_metodo_normal">
                <span class="icon-mode">üè†</span>
                <h3>M√©todo Normal</h3>
                <p>Procedimiento est√°ndar de remates judiciales. C√°lculo tradicional de costos fijos, variables y proyecci√≥n.</p>
            </div>

            <div class="mode-card" onclick="alert('hola ariadna')">
                <span class="badge-new">!</span>
                <span class="icon-mode">‚öñÔ∏è</span>
                <h3>M√©todo Macal</h3>
                <p>Procedimiento especializado para subastas Macal. C√°lculo espec√≠fico de garant√≠as y comisiones del martillero.</p>
            </div>

        </div>
    </div>
    <div id="slide1" class="slide">
        <h2>1. Ficha T√©cnica</h2>
        
        <label>Imagen de la Propiedad (Opcional)</label>
        <div class="file-upload-wrapper">
            <div class="btn-file">üì∑ Toca para subir foto</div>
            <input type="file" id="input_imagen" accept="image/*" onchange="procesarImagen(this)">
        </div>
        <div id="preview-container">
            <img id="preview-img" src="" alt="Vista previa">
        </div>

        <div class="row">
            <div class="col">
                <label>Regi√≥n</label>
                <select id="select_region" py-change="actualizar_comunas">
                    <option value="" disabled selected>Selecciona regi√≥n</option>
                </select>
            </div>
            <div class="col">
                <label>Comuna</label>
                <select id="select_comuna"><option>...</option></select>
            </div>
        </div>

        <label>Nombre Oportunidad</label>
        <input type="text" id="input_nombre" placeholder="Ej: Casa Centro">

        <div class="row">
            <div class="col">
                <label>Fecha Remate</label>
                <input type="date" id="input_fecha_remate">
            </div>
            <div class="col">
                <label>Fecha Rescate</label>
                <input type="date" id="input_fecha_rescate">
            </div>
        </div>
        <label>Fuente de Informaci√≥n</label>
        <input type="text" id="input_fuente" placeholder="Ej: Diario Talca">

        <div class="row">
            <div class="col">
                <label>Direcci√≥n</label>
                <input type="text" id="input_direccion">
            </div>
            <div class="col">
                <label>Superficie (m¬≤)</label>
                <input type="text" inputmode="numeric" pattern="[0-9]*" id="input_superficie" 
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>

        <label>Notas / Estado</label>
        <textarea id="input_detalles" rows="3"></textarea>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_menu_principal">‚Üê Men√∫</button>
            <button class="btn-next" py-click="ir_slide_2">Siguiente ‚ûù</button>
        </div>
    </div>

    <div id="slide2" class="slide">
        <h2>2. Inversi√≥n y Costos</h2>
        
        <div class="row">
            <div class="col">
                <label>Postura M√≠nima ($)</label>
                <input type="number" inputmode="numeric" id="input_postura_min" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="col">
                <label>Oferta M√°xima ($)</label>
                <input type="number" inputmode="numeric" id="input_oferta_max" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Garant√≠a (Vale Vista)</label>
                <input type="number" inputmode="numeric" id="input_garantia" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="col">
                <label>Meses (Inter√©s)</label>
                <input type="number" inputmode="numeric" id="cant_mes" value="0"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>

        <h2 style="font-size: 1rem; border:none; margin-bottom: 5px; color: var(--text-light);">Costos Fijos (Editables)</h2>
        <div class="result-box">
            <div class="result-row">
                <span>‚öñÔ∏è Abogado</span>
                <input type="number" inputmode="numeric" id="costo_abogado" value="1600000" class="input-editable">
            </div>
            <div class="result-row">
                <span>üìù Notar√≠a</span>
                <input type="number" inputmode="numeric" id="costo_notaria" value="300000" class="input-editable">
            </div>
            <div class="result-row">
                <span>üèõÔ∏è CBR</span>
                <input type="number" inputmode="numeric" id="costo_cbr" value="300000" class="input-editable">
            </div>
            <div class="result-row">
                <span>üîì Alzamientos</span>
                <input type="number" inputmode="numeric" id="costo_alzamientos" value="150000" class="input-editable">
            </div>
            <div class="result-row">
                <span>‚öñÔ∏è Judiciales</span>
                <input type="number" inputmode="numeric" id="costo_judiciales" value="300000" class="input-editable">
            </div>
            
            <div class="result-row">
                <span>üîç B√∫squeda (2%)</span>
                <span id="disp_busqueda" class="brand-text">--</span>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_1">‚Üê Atr√°s</button>
            <button class="btn-next" py-click="ir_slide_3">Siguiente ‚ûù</button>
        </div>
    </div>

    <div id="slide3" class="slide">
        <h2>3. Proyecci√≥n Venta</h2>
        
        <label>Precio Venta Estimado ($)</label>
        <span class="small-note">Valor mercado estimado</span>
        <input type="number" inputmode="numeric" id="input_venta_vivienda" value="0"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        
        <div class="row" style="margin-top: 15px;">
             <div class="col">
                <label>üõ†Ô∏è Mejoras / Reformas</label>
                <input type="number" inputmode="numeric" id="input_mejoras" value="3000000"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>
        
        <div class="result-box">
             <div class="result-row">
                <span>ü§ù Comisi√≥n (2%)</span>
                <span id="disp_comision" class="brand-text">--</span>
            </div>
            <div class="result-row">
                <span>üßæ IVA (19%)</span>
                <span id="disp_iva" class="brand-text">--</span>
            </div>
            <div class="result-row">
                 <span>üìÑ Legal Venta</span>
                 <input type="number" inputmode="numeric" id="costo_legal_venta" value="100000" class="input-editable">
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_2">‚Üê Atr√°s</button>
            <button class="btn-next" py-click="calcular_y_mostrar_final">Ver Resultados ‚ûù</button>
        </div>
    </div>

    <div id="slide_final" class="slide">
        <h2>üìä Resumen Financiero</h2>
        
        <div class="result-box">
            
            <div class="interest-highlight">
                <div class="result-row">
                    <span>üè¶ Inter√©s Mensual (0.07%)</span>
                    <span id="res_interes_mensual" class="brand-text">$ 0</span>
                </div>
                <div class="result-row">
                    <span>üìÖ Inter√©s Total Acumulado</span>
                    <span id="res_interes_total" class="red-text">$ 0</span>
                </div>
                <div style="text-align: center; font-size: 0.7rem; color: #666; margin-top: 3px;">(Calculado sobre flujo total de egresos)</div>
            </div>

            <div class="result-row">
                <span>üìâ <strong>Total Egresos</strong></span>
                <span id="res_subtotal_gastos" class="red-text" style="color: #c0392b;">$ 0</span>
            </div>
            <details>
                <summary>Ver Desglose Gastos</summary>
                <div id="breakdown_gastos" class="breakdown-list"></div>
            </details>

            <div class="result-row">
                <span>üìà <strong>Total Ingresos</strong></span>
                <span id="res_total_ingresos" class="green-text">$ 0</span>
            </div>
            <details>
                <summary>Ver Desglose Ingresos</summary>
                <div id="breakdown_ingresos" class="breakdown-list"></div>
            </details>

            <div class="result-row" style="margin-top: 10px; border-top: 2px solid #eee; padding-top: 10px;">
                <span>üí∞ Utilidad Bruta</span>
                <span id="res_saldo_favor" style="font-weight: bold;">$ 0</span>
            </div>

            <div class="result-row">
                <span>üèõÔ∏è Impuesto (27%)</span>
                <span id="res_impuesto" class="brand-text">$ 0</span>
            </div>

            <div class="result-row total-final">
                <span>üöÄ UTILIDAD NETA</span>
                <span id="res_saldo_final_liquido">$ 0</span>
            </div>
            
            <div class="row" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <div class="col" style="text-align: center;">
                    <span style="font-size: 0.8rem; color: #666;">ROI</span><br>
                    <span id="res_roi" style="font-weight: bold; color: var(--dosh-green-dark);">0%</span>
                </div>
                <div class="col" style="text-align: center;">
                    <span style="font-size: 0.8rem; color: #666;">Rentabilidad</span><br>
                    <span id="res_rentabilidad" style="font-weight: bold; color: var(--dosh-blue);">0%</span>
                </div>
            </div>
        </div>

        <button class="btn-pdf" py-click="generar_pdf_completo">üì• Descargar Ficha PDF Detallada</button>
        <button class="btn-new" py-click="nueva_operacion">üîÑ Nueva Operaci√≥n / Men√∫</button>
        <div id="mensaje"></div>

        <div class="nav-buttons">
            <button class="btn-back" py-click="ir_slide_3">‚Üê Editar</button>
        </div>
    </div>
    <div id="sec_ia" style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; display: none;">
        <h2>ü§ñ Asesor√≠a con IA (Groq)</h2>
        <button onclick="consultarGroq()" 
                style="background: linear-gradient(45deg, #4285f4, #9b72cb); color: white; width: 100%;">
            ‚ú® Analizar Oportunidad con IA
        </button>

        <div id="loading_ai" style="display:none; text-align: center; margin-top: 15px;">
            <p>üß† Analizando n√∫meros... por favor espera...</p>
        </div>

        <div id="resultado_ai" style="margin-top: 15px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; display: none; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5;"></div>
    </div>
</div>

<script type="py">
    from pyscript import document, window
    from js import jspdf
    import datetime

    CHILE_DATA = {
        "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
        "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"],
        "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"],
        "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
        "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paihuano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"],
        "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"],
        "Metropolitana": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"],
        "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchig√ºe", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
        "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
        "√ëuble": ["Chill√°n", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chill√°n Viejo", "El Carmen", "Ninhue", "√ëiqu√©n", "Pemuco", "Pinto", "Portezuelo", "Quill√≥n", "Quirihue", "R√°nquil", "San Carlos", "San Fabi√°n", "San Ignacio", "San Nicol√°s", "Treguaco", "Yungay"],
        "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"],
        "Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"],
        "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"],
        "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"],
        "Ays√©n": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"],
        "Magallanes": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
    }

    # VALORES POR DEFECTO
    DEF_ABOGADO = 1600000
    DEF_NOTARIA = 300000
    DEF_CBR = 300000
    DEF_ALZAMIENTOS = 150000
    DEF_JUDICIALES = 300000
    DEF_LEGAL_VENTA = 100000

    def format_money(valor):
        return "${:,.0f}".format(valor).replace(",", ".")

    def iniciar_app():
        select = document.getElementById("select_region")
        for reg in CHILE_DATA.keys():
            opt = document.createElement("option")
            opt.text = reg
            opt.value = reg
            select.add(opt)

    def actualizar_comunas(event):
        reg = event.target.value
        sel_com = document.getElementById("select_comuna")
        sel_com.innerHTML = ""
        for c in CHILE_DATA.get(reg, []):
            opt = document.createElement("option")
            opt.text = c
            opt.value = c
            sel_com.add(opt)

    # --- NAVEGACI√ìN ACTUALIZADA ---
    def cambiar_slide(id_mostrar):
        # Agregamos el nuevo slide_selection a la lista
        ids = ["slide_selection", "slide1", "slide2", "slide3", "slide_final"]
        
        # Actualizar subt√≠tulo y visibilidad de IA seg√∫n la pantalla
        subt = document.getElementById("main_subtitle")
        sec_ia = document.getElementById("sec_ia")
        
        if id_mostrar == "slide_selection":
             subt.innerText = "Selecciona el tipo de evaluaci√≥n"
             sec_ia.style.display = "none"
        elif id_mostrar == "slide_final":
             subt.innerText = "Resumen de Resultados"
             sec_ia.style.display = "block"
        else:
             subt.innerText = "Evaluaci√≥n Econ√≥mica de Remates"
             sec_ia.style.display = "none"

        for i in ids:
            el = document.getElementById(i)
            if i == id_mostrar:
                el.classList.add("active")
            else:
                el.classList.remove("active")
        window.scrollTo(0, 0)

    # --- NUEVAS FUNCIONES DE MEN√ö ---
    def ir_menu_principal(e):
        cambiar_slide("slide_selection")
    
    def iniciar_metodo_normal(e):
        # Aqu√≠ iremos al slide 1 del m√©todo normal
        cambiar_slide("slide1")
        
    # Funciones de navegaci√≥n existentes
    def ir_slide_1(e): cambiar_slide("slide1")
    def ir_slide_2(e): cambiar_slide("slide2")
    def ir_slide_3(e): cambiar_slide("slide3")

    # --- RESETEO (MODIFICADO) ---
    def nueva_operacion(e):
        ids_text = ["input_nombre", "input_direccion", "input_superficie", "input_detalles", "input_fuente"]
        for i in ids_text: document.getElementById(i).value = ""

        ids_num = ["input_postura_min", "input_oferta_max", "input_garantia", 
                   "input_venta_vivienda", "input_mejoras", "cant_mes"]
        for i in ids_num: document.getElementById(i).value = "0"
        
        # Reset Costos Fijos
        document.getElementById("costo_abogado").value = str(DEF_ABOGADO)
        document.getElementById("costo_notaria").value = str(DEF_NOTARIA)
        document.getElementById("costo_cbr").value = str(DEF_CBR)
        document.getElementById("costo_alzamientos").value = str(DEF_ALZAMIENTOS)
        document.getElementById("costo_judiciales").value = str(DEF_JUDICIALES)
        document.getElementById("costo_legal_venta").value = str(DEF_LEGAL_VENTA)
        document.getElementById("input_mejoras").value = "3000000"
        
        # Reset fechas
        document.getElementById("input_fecha_remate").value = ""
        document.getElementById("input_fecha_rescate").value = ""

        document.getElementById("select_region").selectedIndex = 0
        document.getElementById("select_comuna").innerHTML = "<option>...</option>"

        spans_calc = ["disp_busqueda", "disp_comision", "disp_iva", "res_interes_mensual", "res_interes_total", "res_roi", "res_rentabilidad"]
        for s in spans_calc: 
            elem = document.getElementById(s)
            if elem: elem.innerText = "--"

        spans_res = ["res_subtotal_gastos", "res_total_ingresos", "res_saldo_favor", "res_impuesto", "res_saldo_final_liquido"]
        for s in spans_res: document.getElementById(s).innerText = "$ 0"
            
        document.getElementById("mensaje").innerText = ""
        document.getElementById("breakdown_gastos").innerHTML = ""
        document.getElementById("breakdown_ingresos").innerHTML = ""
        document.getElementById("resultado_ai").innerHTML = ""
        document.getElementById("resultado_ai").style.display = "none"
        
        # Limpiar imagen
        document.getElementById("input_imagen").value = ""
        document.getElementById("preview-img").src = ""
        document.getElementById("preview-container").style.display = "none"
        document.querySelector(".btn-file").innerText = "üì∑ Toca para subir foto"

        # AL RESETEAR, VOLVEMOS AL MEN√ö PRINCIPAL
        cambiar_slide("slide_selection")

    # --- C√ÅLCULOS ---
    def get_val(id_elem):
        v = document.getElementById(id_elem).value
        if not v: return 0.0
        try: return float(v)
        except: return 0.0

    def crear_fila_desglose(label, valor):
        return f'<div class="breakdown-item"><span>{label}</span><span>{format_money(valor)}</span></div>'
    
    def crear_titulo_desglose(titulo):
        return f'<div class="breakdown-title">{titulo}</div>'

    def calcular_y_mostrar_final(e):
        # 1. Inputs Generales
        postura_min = get_val("input_postura_min")
        oferta_max = get_val("input_oferta_max") 
        garantia = get_val("input_garantia")
        venta_vivienda = get_val("input_venta_vivienda")
        costo_mejoras = get_val("input_mejoras")
        meses_interes = get_val("cant_mes")
        
        # 2. Inputs de Costos Fijos
        c_abogado = get_val("costo_abogado")
        c_notaria = get_val("costo_notaria")
        c_cbr = get_val("costo_cbr")
        c_alzamientos = get_val("costo_alzamientos")
        c_judiciales = get_val("costo_judiciales")
        c_legal_venta = get_val("costo_legal_venta")

        # 3. C√°lculos Variables
        suma_ofertas = postura_min + oferta_max
        honorarios_busqueda = suma_ofertas * 0.02
        comision_venta = venta_vivienda * 0.02
        iva_venta = (venta_vivienda / 1.19) * 0.19
        
        # 4. BASE DE C√ÅLCULO INTER√âS (Sin Deudas)
        gastos_fijos_compra = c_abogado + c_notaria + c_cbr + c_alzamientos + c_judiciales
        
        base_calculo_interes = (honorarios_busqueda + 
                                gastos_fijos_compra + 
                                garantia + 
                                postura_min + 
                                oferta_max + 
                                costo_mejoras + 
                                comision_venta + 
                                c_legal_venta + 
                                iva_venta)

        interes_mensual = base_calculo_interes * 0.0007
        interes_total = interes_mensual * meses_interes

        # 5. Gastos Finales
        subtotal_gasto = base_calculo_interes + interes_total

        # INGRESOS
        total_ingresos = venta_vivienda + garantia
        
        # RESULTADOS
        saldo_favor = total_ingresos - subtotal_gasto
        impuesto = saldo_favor * 0.27 if saldo_favor > 0 else 0
        saldo_final = saldo_favor - impuesto

        # KPIs
        roi = (saldo_final / subtotal_gasto) * 100 if subtotal_gasto > 0 else 0
        rentabilidad = (saldo_final / venta_vivienda) * 100 if venta_vivienda > 0 else 0

        # 6. Actualizar UI
        document.getElementById("disp_busqueda").innerText = format_money(honorarios_busqueda)
        document.getElementById("disp_comision").innerText = format_money(comision_venta)
        document.getElementById("disp_iva").innerText = format_money(iva_venta)
        
        document.getElementById("res_interes_mensual").innerText = format_money(interes_mensual)
        document.getElementById("res_interes_total").innerText = format_money(interes_total)

        document.getElementById("res_subtotal_gastos").innerText = format_money(subtotal_gasto)
        document.getElementById("res_total_ingresos").innerText = format_money(total_ingresos)
        document.getElementById("res_saldo_favor").innerText = format_money(saldo_favor)
        document.getElementById("res_impuesto").innerText = format_money(impuesto)
        document.getElementById("res_saldo_final_liquido").innerText = format_money(saldo_final)
        
        document.getElementById("res_roi").innerText = "{:.1f}%".format(roi)
        document.getElementById("res_rentabilidad").innerText = "{:.1f}%".format(rentabilidad)

        # 7. DESGLOSE
        html_gastos = ""
        html_gastos += crear_titulo_desglose("1. Inversi√≥n Inicial")
        html_gastos += crear_fila_desglose("Postura M√≠nima", postura_min)
        html_gastos += crear_fila_desglose("Oferta M√°xima", oferta_max)
        html_gastos += crear_fila_desglose("Garant√≠a (Vale Vista)", garantia)
        
        html_gastos += crear_titulo_desglose("2. Gastos Operacionales")
        html_gastos += crear_fila_desglose("Honorarios B√∫squeda", honorarios_busqueda)
        html_gastos += crear_fila_desglose("Abogado", c_abogado)
        html_gastos += crear_fila_desglose("Notar√≠a", c_notaria)
        html_gastos += crear_fila_desglose("CBR", c_cbr)
        html_gastos += crear_fila_desglose("Alzamientos", c_alzamientos)
        html_gastos += crear_fila_desglose("Judiciales", c_judiciales)
        
        html_gastos += crear_titulo_desglose("3. Habilitaci√≥n y Venta")
        html_gastos += crear_fila_desglose("Mejoras Vivienda", costo_mejoras)
        html_gastos += crear_fila_desglose("IVA D√©bito", iva_venta)
        html_gastos += crear_fila_desglose("Comisi√≥n Venta (2%)", comision_venta)
        html_gastos += crear_fila_desglose("Documentos Legales", c_legal_venta)
        
        html_gastos += crear_titulo_desglose("4. Costo Financiero")
        html_gastos += crear_fila_desglose(f"Inter√©s ({meses_interes} meses)", interes_total)
        
        document.getElementById("breakdown_gastos").innerHTML = html_gastos

        html_ingresos = ""
        html_ingresos += crear_titulo_desglose("Entradas de Dinero")
        html_ingresos += crear_fila_desglose("Venta Vivienda", venta_vivienda)
        html_ingresos += crear_fila_desglose("Reembolso Garant√≠a", garantia)
        document.getElementById("breakdown_ingresos").innerHTML = html_ingresos

        cambiar_slide("slide_final")

    # --- PDF ---
    def generar_pdf_completo(e):
        # Recalcular todo para el PDF
        postura_min = get_val("input_postura_min")
        oferta_max = get_val("input_oferta_max")
        garantia = get_val("input_garantia")
        venta_vivienda = get_val("input_venta_vivienda")
        costo_mejoras = get_val("input_mejoras")
        meses_interes = get_val("cant_mes")
        
        c_abogado = get_val("costo_abogado")
        c_notaria = get_val("costo_notaria")
        c_cbr = get_val("costo_cbr")
        c_alzamientos = get_val("costo_alzamientos")
        c_judiciales = get_val("costo_judiciales")
        c_legal_venta = get_val("costo_legal_venta")
        
        suma_ofertas = postura_min + oferta_max
        honorarios_busqueda = suma_ofertas * 0.02
        comision_venta = venta_vivienda * 0.02
        iva_venta = (venta_vivienda / 1.19) * 0.19
        
        gastos_fijos_compra = c_abogado + c_notaria + c_cbr + c_alzamientos + c_judiciales
        
        base_calculo_interes = (honorarios_busqueda + 
                                gastos_fijos_compra + 
                                garantia + 
                                postura_min + 
                                oferta_max + 
                                costo_mejoras + 
                                comision_venta + 
                                c_legal_venta + 
                                iva_venta)

        interes_mensual = base_calculo_interes * 0.0007
        interes_total = interes_mensual * meses_interes
        
        subtotal_gasto = base_calculo_interes + interes_total
        total_ingresos = venta_vivienda + garantia
        saldo_favor = total_ingresos - subtotal_gasto
        impuesto = saldo_favor * 0.27 if saldo_favor > 0 else 0
        saldo_final = saldo_favor - impuesto

        nombre = document.getElementById("input_nombre").value
        
        # Info extra
        str_f_remate = document.getElementById("input_fecha_remate").value or "No indicada"
        str_f_rescate = document.getElementById("input_fecha_rescate").value or "No indicada"
        str_fuente = document.getElementById("input_fuente").value or "No indicada"
        
        img_element = document.getElementById("preview-img")
        notas_raw = document.getElementById("input_detalles").value
        notas_final = notas_raw.strip() if notas_raw.strip() else "NO NOTA"

        doc = window.jspdf.jsPDF.new()
        
        doc.setFont("helvetica", "bold")
        doc.setFontSize(20)
        doc.text("FICHA ECONOMICA DE REMATE", 20, 25)
        
        if img_element.src and "data:image" in img_element.src:
            try:
                orig_w = img_element.naturalWidth
                orig_h = img_element.naturalHeight
                max_w = 50; max_h = 50
                ratio = orig_w / orig_h
                if ratio > 1: final_w = max_w; final_h = max_w / ratio
                else: final_h = max_h; final_w = max_h * ratio
                doc.addImage(img_element.src, "JPEG", 140, 10, final_w, final_h)
            except: pass 

        doc.setFontSize(12)
        doc.text(f"Oportunidad: {nombre}", 20, 40)
        
        doc.setFontSize(10)
        doc.text(f"Fecha Remate: {str_f_remate} | Fecha Rescate: {str_f_rescate}", 20, 48)
        doc.text(f"Fuente: {str_fuente}", 20, 54)
        
        doc.setFontSize(12)
        doc.text(f"Ubicaci√≥n: {document.getElementById('select_comuna').value}, {document.getElementById('select_region').value}", 20, 64)
        doc.text(f"Direcci√≥n: {document.getElementById('input_direccion').value}", 20, 72)
        
        y_pos = 85
        if notas_final == "NO NOTA":
            doc.setTextColor(220, 53, 69); doc.text(f"Estado/Notas: {notas_final}", 20, y_pos); doc.setTextColor(0, 0, 0)
        else:
            doc.setFont("helvetica", "normal"); doc.setFontSize(10)
            split_notas = doc.splitTextToSize(f"Notas: {notas_final}", 170)
            doc.text(split_notas, 20, y_pos)
            y_pos += (len(split_notas) * 5) 

        doc.line(20, y_pos + 5, 190, y_pos + 5)
        y = y_pos + 20
        
        # --- DETALLE TIPO BOLETA ---
        doc.setFontSize(14); doc.setFont("helvetica", "bold")
        doc.text("Detalle Financiero", 20, y); y += 10
        doc.setFontSize(10); doc.setFont("helvetica", "normal")
        
        doc.text("1. INVERSION INICIAL", 20, y); y += 5
        doc.text(f"   - Postura + Oferta + Garantia: {format_money(postura_min + oferta_max + garantia)}", 20, y); y+=8
        
        doc.text("2. GASTOS OPERACIONALES", 20, y); y += 5
        doc.text(f"   - Honorarios y Legal: {format_money(honorarios_busqueda + gastos_fijos_compra)}", 20, y); y+=8
        
        doc.text("3. COSTOS FINANCIEROS", 20, y); y += 5
        doc.text(f"   - Interes Mensual (0.07%): {format_money(interes_mensual)}", 20, y); y+=5
        doc.text(f"   - Total Intereses ({meses_interes} meses): {format_money(interes_total)}", 20, y); y+=8
        
        doc.text("4. HABILITACION Y VENTA", 20, y); y += 5
        doc.text(f"   - Mejoras + Comision + Legal: {format_money(costo_mejoras + comision_venta + c_legal_venta)}", 20, y); y+=5
        doc.text(f"   - IVA Debito: {format_money(iva_venta)}", 20, y); y+=10
        
        doc.line(20, y, 100, y); y+=5
        doc.setFont("helvetica", "bold")
        doc.text(f"TOTAL EGRESOS: {format_money(subtotal_gasto)}", 20, y); y+=10
        doc.text(f"TOTAL INGRESOS: {format_money(total_ingresos)}", 20, y); y+=15

        doc.setFillColor(240, 240, 240); doc.rect(15, y-5, 180, 40, "F")
        doc.setFontSize(12)
        doc.text(f"Utilidad Bruta: {format_money(saldo_favor)}", 20, y+5)
        doc.text(f"Impuesto (27%): - {format_money(impuesto)}", 20, y+15)
        doc.setFontSize(16); doc.setTextColor(0, 100, 0)
        doc.text(f"UTILIDAD NETA FINAL: {format_money(saldo_final)}", 20, y+30)
        
        doc.save(f"Ficha_{nombre}.pdf")
        document.getElementById("mensaje").innerText = "‚úÖ PDF Generado con √©xito"

    iniciar_app()
</script>

<script>
    async function consultarGroq() {
        // 1. Recopilar datos (que Python ya calcul√≥)
        const nombre = document.getElementById('input_nombre').value;
        const totalGastos = document.getElementById('res_subtotal_gastos').innerText;
        const totalIngresos = document.getElementById('res_total_ingresos').innerText;
        const utilidad = document.getElementById('res_saldo_final_liquido').innerText;
        const roi = document.getElementById('res_roi').innerText;
        const rentabilidad = document.getElementById('res_rentabilidad').innerText;
        const notas = document.getElementById('input_detalles').value;

        // 2. Crear el Prompt
        const prompt = `
            Act√∫a como un experto inversionista inmobiliario senior y asesor financiero de la constructora DosH.
            Analiza los siguientes datos de una oportunidad de remate y dame un veredicto cr√≠tico y profesional.
            
            DATOS DEL NEGOCIO:
            - Oportunidad: ${nombre}
            - Inversi√≥n Total (Gastos + Compra): ${totalGastos}
            - Ingresos Estimados (Venta): ${totalIngresos}
            - Utilidad Neta Final: ${utilidad}
            - ROI (Retorno s/ Inversi√≥n): ${roi}
            - Rentabilidad s/ Venta: ${rentabilidad}
            - Notas adicionales del terreno/propiedad: "${notas}"

            TU TAREA:
            1. Eval√∫a si el ROI y la Rentabilidad son atractivos.
            2. Identifica posibles riesgos.
            3. Da un veredicto final: ¬øAprobar√≠as esta inversi√≥n?
            4. Se breve, directo y usa formato con vi√±etas.
        `;

        // 3. UI Loading
        document.getElementById('loading_ai').style.display = 'block';
        document.getElementById('resultado_ai').style.display = 'none';

        try {
            // Llamamos a TU propia API en Vercel
            const response = await fetch('/api/analizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await response.json();
            
            if (data.result) {
                const resultDiv = document.getElementById('resultado_ai');
                
                // Formatear
                resultDiv.innerHTML = data.result
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                
                resultDiv.style.display = 'block';
                resultDiv.style.borderLeft = "5px solid #9CBF28";
            } else {
                alert("Error: " + (data.error || "Error desconocido"));
            }

        } catch (error) {
            console.error(error);
            alert("Error de conexi√≥n con el servidor. Aseg√∫rate de que los archivos de Vercel (api/analizar.js) est√°n subidos.");
        } finally {
            document.getElementById('loading_ai').style.display = 'none';
        }
    }
</script>

</body>
</html>
